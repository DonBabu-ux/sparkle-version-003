<%- include('partials/head', { title: 'Groups' }) %>


    <body>
        <%- include('partials/sidebar') %>

            <!-- Main Content Container -->
            <div class="container" id="mainContent">
                <!-- Discover Groups Page -->
                <div id="groupsPage" class="page active">
                    <div class="header glass">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <div class="hamburger-btn" onclick="window.location.href='/'">
                                <i class="fas fa-chevron-left"></i>
                            </div>
                            <div class="logo-text">Discover Groups</div>
                        </div>
                    </div>

                    <!-- Search & Filters -->
                    <div class="premium-search-container" style="margin: 20px 0;">
                        <i class="fas fa-search"></i>
                        <input type="text" class="premium-search-input" placeholder="Search groups by name or topic...">
                    </div>

                    <div class="premium-tabs">
                        <button
                            class="premium-tab-btn <%= typeof activeFilter !== 'undefined' && activeFilter === 'all' ? 'active' : '' %>"
                            onclick="window.location.href='/groups'">All Groups</button>
                        <button
                            class="premium-tab-btn <%= typeof activeFilter !== 'undefined' && activeFilter === 'my' ? 'active' : '' %>"
                            onclick="window.location.href='/groups?filter=my'">My Groups</button>
                        <button
                            class="premium-tab-btn <%= typeof activeFilter !== 'undefined' && activeFilter === 'managed' ? 'active' : '' %>"
                            onclick="window.location.href='/groups?filter=managed'">Managed Groups</button>
                    </div>

                    <!-- Grid -->
                    <div class="discover-grid" id="groupsContainer">
                        <% if (typeof initialGroups !=='undefined' && initialGroups.length> 0) { %>
                            <% initialGroups.forEach(group=> { %>
                                <div class="discover-card"
                                    onclick="window.location.href='/groups/<%= group.group_id %>'">
                                    <div class="discover-card-banner">
                                        <% if (group.icon_url) { %>
                                            <img src="<%= group.icon_url %>" class="group-icon-img"
                                                alt="<%= group.name %>">
                                            <% } else { %>
                                                <i
                                                    class="<%= group.icon || 'fas fa-users' %> group-placeholder-icon"></i>
                                                <% } %>
                                                    <div class="discover-card-badge">
                                                        <%= group.member_count || 0 %> members
                                                    </div>
                                    </div>

                                    <div class="discover-card-content">
                                        <div class="discover-card-category">
                                            <%= group.category || 'General' %>
                                        </div>
                                        <h3 class="discover-card-name">
                                            <%= group.name %>
                                        </h3>
                                        <p class="discover-card-bio">
                                            <%= group.description || 'No description available for this group.' %>
                                        </p>

                                        <div class="discover-card-footer">
                                            <% if (group.user_status==='active' ) { %>
                                                <div class="status-badge joined">
                                                    <i class="fas fa-check-circle"></i> Joined
                                                </div>
                                                <% } else if (group.user_status==='pending' ) { %>
                                                    <div class="status-badge pending">
                                                        <i class="fas fa-clock"></i> Pending
                                                    </div>
                                                    <% } else { %>
                                                        <div class="status-badge public">
                                                            Public Group
                                                        </div>
                                                        <% } %>

                                                            <div class="view-link">
                                                                View <i class="fas fa-arrow-right"></i>
                                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <% }); %>
                                    <% } else { %>
                                        <div class="discover-empty-state">
                                            <div class="empty-icon-wrapper">
                                                <i class="fas fa-users-slash"></i>
                                            </div>
                                            <h4>No groups found</h4>
                                            <p>Start a new community by creating a group!</p>
                                        </div>
                                        <% } %>
                    </div>

                    <button class="fab-btn" id="createGroupBtn">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>

            <!-- Create Group Modal -->
            <div id="createGroupModalWrapper" class="premium-modal">
                <div class="premium-modal-content">
                    <div class="premium-modal-header">
                        <h3 class="premium-modal-title">Create New Group</h3>
                        <button class="close-modal"
                            onclick="document.getElementById('createGroupModalWrapper').style.display='none'">&times;</button>
                    </div>
                    <div class="premium-modal-body">
                        <form id="createGroupFormAction">
                            <div class="form-group">
                                <label class="form-label">Group Name*</label>
                                <input type="text" id="newGroupName" class="form-input" required
                                    placeholder="e.g. Study Group 101">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Category*</label>
                                <select id="newGroupCategory" class="form-input" required>
                                    <option value="study">Study</option>
                                    <option value="social">Social</option>
                                    <option value="sports">Sports</option>
                                    <option value="hobby">Hobby</option>
                                    <option value="academic">Academic</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Group Icon (Optional)</label>
                                <input type="file" id="newGroupIconFile" class="form-input" accept="image/*">
                            </div>

                            <div class="form-group" style="display:none;">
                                <label class="form-label">Icon URL (Legacy)</label>
                                <input type="text" id="newGroupIconUrl" class="form-input"
                                    placeholder="e.g. /uploads/groups/study.png">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Description</label>
                                <textarea id="newGroupDescription" class="form-input" rows="3"
                                    placeholder="What is this group about?"></textarea>
                            </div>

                            <div class="form-group"
                                style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                                <input type="checkbox" id="newGroupRequireApproval"
                                    style="width: 18px; height: 18px; cursor: pointer;">
                                <label for="newGroupRequireApproval"
                                    style="margin: 0; font-size: 14px; cursor: pointer;">Require Approval to
                                    Join</label>
                            </div>

                            <button type="submit" class="settings-save-btn" style="width: 100%; margin-top: 0;">Create
                                Group</button>
                        </form>
                    </div>
                </div>
            </div>

            <%- include('partials/dashboard-modals') %>
                <script src="/js/dashboardAPI.js"></script>
                <script>
                    // Global Sidebar Compatibility Functions
                    function createGroup() {
                        const modal = document.getElementById('createGroupModalWrapper');
                        if (modal) modal.style.display = 'flex';
                    }

                    function showGroupManagement() {
                        // Already on the management page, maybe scroll to top or filter?
                        window.location.href = '/groups';
                    }

                    function showGroupFeed() {
                        // For now keep on groups page or redirect if specific feed route exists
                        window.location.href = '/groups';
                    }

                    function hideHamburger() {
                        const menu = document.getElementById('hamburgerMenu');
                        const overlay = document.getElementById('hamburgerOverlay');
                        if (menu) menu.classList.remove('active');
                        if (overlay) overlay.classList.remove('active');
                    }

                    // Hamburger toggle logic
                    document.addEventListener('DOMContentLoaded', () => {
                        const hamburgerBtn = document.querySelector('.hamburger-btn');
                        if (hamburgerBtn) {
                            hamburgerBtn.addEventListener('click', () => {
                                const menu = document.getElementById('hamburgerMenu');
                                const overlay = document.getElementById('hamburgerOverlay');
                                if (menu) menu.classList.add('active');
                                if (overlay) overlay.classList.add('active');
                            });
                        }

                        const closeBtn = document.getElementById('closeHamburger');
                        if (closeBtn) {
                            closeBtn.addEventListener('click', hideHamburger);
                        }

                        const overlay = document.getElementById('hamburgerOverlay');
                        if (overlay) {
                            overlay.addEventListener('click', hideHamburger);
                        }
                    });

                    // Scroll header effect
                    const groupsPage = document.getElementById('groupsPage');
                    if (groupsPage) {
                        groupsPage.addEventListener('scroll', () => {
                            const header = groupsPage.querySelector('.header');
                            if (groupsPage.scrollTop > 10) {
                                header?.classList.add('glass-effect');
                            } else {
                                header?.classList.remove('glass-effect');
                            }
                        });
                    }

                    const createGroupBtn = document.getElementById('createGroupBtn');
                    if (createGroupBtn) {
                        createGroupBtn.addEventListener('click', () => {
                            document.getElementById('createGroupModalWrapper').style.display = 'flex';
                        });
                    }

                    const createGroupForm = document.getElementById('createGroupFormAction');
                    if (createGroupForm) {
                        createGroupForm.addEventListener('submit', async (e) => {
                            e.preventDefault();
                            const btn = e.target.querySelector('button[type="submit"]');
                            btn.disabled = true;
                            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';

                            const formData = new FormData();
                            formData.append('name', document.getElementById('newGroupName').value);
                            formData.append('category', document.getElementById('newGroupCategory').value);
                            formData.append('description', document.getElementById('newGroupDescription').value);
                            formData.append('requires_approval', document.getElementById('newGroupRequireApproval').checked);
                            formData.append('campus', '<%= user.campus %>');
                            formData.append('is_public', true);

                            const fileInput = document.getElementById('newGroupIconFile');
                            if (fileInput.files.length > 0) {
                                formData.append('pfp', fileInput.files[0]);
                            } else {
                                const legacyUrl = document.getElementById('newGroupIconUrl').value;
                                if (legacyUrl) formData.append('photo_url', legacyUrl);
                            }

                            try {
                                const API = window.DashboardAPI || window.dashboardAPI;
                                if (!API) throw new Error('API not loaded');

                                const response = await API.fetchWithAuth('/groups', {
                                    method: 'POST',
                                    body: formData
                                    // No Content-Type header; fetch adds it with boundary for FormData
                                });

                                const result = response;

                                if (result && (result.group_id || result.id)) {
                                    window.location.href = `/groups/${result.group_id || result.id}`;
                                } else {
                                    alert('Group created but ID missing');
                                    window.location.reload();
                                }
                            } catch (err) {
                                console.error('Error:', err);
                                alert('Failed to create group: ' + (err.message || 'Unknown error'));
                                btn.disabled = false;
                                btn.innerText = 'Create Group';
                            }
                        });
                    }

                    // Tab Filtering Logic - REMOVED (Handled Server Side)
                    /*
                    const tabs = document.querySelectorAll('.premium-tab-btn');
                    // ... (legacy code removed to prevent conflict)
                    */
                </script>

                <style>
                    /* Premium Styling Overrides */
                    .discover-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                        gap: 24px;
                        padding-bottom: 100px;
                    }

                    .discover-card {
                        border: none;
                        border-radius: 24px;
                        overflow: hidden;
                        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
                        /* Softer shadow */
                        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
                        background: #fff;
                        display: flex;
                        flex-direction: column;
                        cursor: pointer;
                        position: relative;
                        isolation: isolate;
                        padding: 0 !important;
                        /* CRITICAL FIX: Remove inherited padding */
                    }

                    .discover-card:hover {
                        transform: translateY(-8px) scale(1.02);
                        box-shadow: 0 20px 50px rgba(255, 61, 109, 0.2);
                        z-index: 10;
                    }

                    .discover-card-banner {
                        height: 140px;
                        /* Increased height */
                        width: 100%;
                        /* Full width */
                        background: linear-gradient(135deg, #FF6B95, #FF3D6D);
                        position: relative;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        overflow: hidden;
                    }

                    .discover-card-banner::before {
                        content: '';
                        position: absolute;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: radial-gradient(circle at top right, rgba(255, 255, 255, 0.2), transparent);
                    }

                    .group-icon-img {
                        width: 100%;
                        height: 100%;
                        object-fit: cover;
                        transition: transform 0.5s ease;
                    }

                    .discover-card:hover .group-icon-img {
                        transform: scale(1.1);
                    }

                    .group-placeholder-icon {
                        font-size: 48px;
                        /* Larger icon */
                        opacity: 0.95;
                        filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.2));
                    }

                    .discover-card-badge {
                        position: absolute;
                        bottom: 12px;
                        right: 12px;
                        background: rgba(255, 255, 255, 0.25);
                        backdrop-filter: blur(8px);
                        -webkit-backdrop-filter: blur(8px);
                        color: white;
                        padding: 6px 14px;
                        border-radius: 20px;
                        font-size: 0.75rem;
                        font-weight: 600;
                        border: 1px solid rgba(255, 255, 255, 0.4);
                        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
                        z-index: 2;
                    }

                    .discover-card-content {
                        padding: 24px;
                        flex: 1;
                        display: flex;
                        flex-direction: column;
                        background: #fff;
                    }

                    .discover-card-category {
                        font-size: 0.7rem;
                        text-transform: uppercase;
                        letter-spacing: 1.5px;
                        color: var(--primary);
                        font-weight: 800;
                        margin-bottom: 10px;
                        opacity: 0.9;
                    }

                    .discover-card-name {
                        font-family: 'Outfit', sans-serif;
                        font-weight: 700;
                        font-size: 1.35rem;
                        /* Larger title */
                        color: #1e293b;
                        margin: 0 0 10px 0;
                        line-height: 1.3;
                    }

                    .discover-card-bio {
                        font-size: 0.95rem;
                        color: #64748b;
                        line-height: 1.6;
                        margin: 0 0 24px 0;
                        display: -webkit-box;
                        -webkit-line-clamp: 2;
                        line-clamp: 2;
                        -webkit-box-orient: vertical;
                        overflow: hidden;
                        flex: 1;
                    }

                    .discover-card-footer {
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        padding-top: 16px;
                        border-top: 1px solid #f1f5f9;
                        margin-top: auto;
                        width: 100%;
                    }

                    .status-badge {
                        font-size: 0.8rem;
                        font-weight: 700;
                        display: flex;
                        align-items: center;
                        gap: 6px;
                    }

                    .status-badge.joined {
                        color: #10b981;
                    }

                    .status-badge.pending {
                        color: #f59e0b;
                    }

                    .status-badge.public {
                        color: #94a3b8;
                        font-weight: 600;
                    }

                    .view-link {
                        font-size: 0.85rem;
                        font-weight: 700;
                        color: var(--primary);
                        display: flex;
                        align-items: center;
                        gap: 6px;
                        transition: gap 0.2s ease;
                        cursor: pointer;
                    }

                    .discover-card:hover .view-link {
                        gap: 10px;
                    }

                    .premium-tab-btn {
                        border-radius: 50px;
                        padding: 10px 24px;
                        font-weight: 600;
                        transition: all 0.3s ease;
                        font-size: 0.95rem;
                        border: 1px solid transparent;
                        background: #f8fafc;
                        color: #64748b;
                        cursor: pointer;
                    }

                    .premium-tab-btn:hover {
                        background: #f1f5f9;
                        transform: translateY(-2px);
                    }

                    .premium-tab-btn.active {
                        background: linear-gradient(135deg, var(--primary), var(--secondary));
                        color: white !important;
                        box-shadow: 0 8px 20px rgba(233, 30, 99, 0.3);
                        transform: translateY(-2px);
                    }

                    .fab-btn {
                        background: linear-gradient(135deg, var(--primary), var(--secondary));
                        box-shadow: 0 4px 20px rgba(233, 30, 99, 0.4);
                        transition: transform 0.3s ease;
                    }

                    .fab-btn:hover {
                        transform: scale(1.1) rotate(90deg);
                    }

                    @keyframes fadeIn {
                        from {
                            opacity: 0;
                            transform: translateY(10px);
                        }

                        to {
                            opacity: 1;
                            transform: translateY(0);
                        }
                    }

                    .glass-effect {
                        background: rgba(255, 255, 255, 0.9);
                        backdrop-filter: blur(16px);
                        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
                        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.02);
                    }

                    .discover-empty-state {
                        grid-column: 1 / -1;
                        text-align: center;
                        padding: 60px 20px;
                        background: white;
                        border-radius: 30px;
                        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.05);
                    }

                    .empty-icon-wrapper {
                        width: 80px;
                        height: 80px;
                        background: #fef2f2;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        margin: 0 auto 24px;
                        color: var(--primary);
                        font-size: 32px;
                    }

                    /* Modal Styling */
                    .premium-modal {
                        display: none;
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.4);
                        backdrop-filter: blur(8px);
                        -webkit-backdrop-filter: blur(8px);
                        z-index: 1000;
                        align-items: center;
                        justify-content: center;
                        animation: fadeIn 0.3s ease;
                    }

                    .premium-modal-content {
                        background: white;
                        width: 90%;
                        max-width: 500px;
                        border-radius: 24px;
                        padding: 0;
                        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
                        transform: translateY(20px);
                        animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
                        overflow: hidden;
                    }

                    .premium-modal-header {
                        padding: 24px 24px 10px;
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                    }

                    .premium-modal-title {
                        font-size: 1.5rem;
                        font-weight: 700;
                        color: #1e293b;
                        margin: 0;
                        font-family: 'Outfit', sans-serif;
                    }

                    .close-modal {
                        background: #f1f5f9;
                        border: none;
                        width: 36px;
                        height: 36px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 1.2rem;
                        color: #64748b;
                        cursor: pointer;
                        transition: all 0.2s ease;
                    }

                    .close-modal:hover {
                        background: #e2e8f0;
                        color: #ef4444;
                    }

                    .premium-modal-body {
                        padding: 24px;
                    }

                    .form-group {
                        margin-bottom: 20px;
                    }

                    .form-label {
                        display: block;
                        font-size: 0.9rem;
                        font-weight: 600;
                        color: #475569;
                        margin-bottom: 8px;
                    }

                    .form-input {
                        width: 100%;
                        padding: 14px 16px;
                        border-radius: 12px;
                        border: 2px solid #e2e8f0;
                        font-size: 1rem;
                        transition: all 0.3s ease;
                        font-family: inherit;
                        background: #f8fafc;
                    }

                    .form-input:focus {
                        border-color: var(--primary);
                        background: white;
                        box-shadow: 0 0 0 4px rgba(255, 61, 109, 0.1);
                        outline: none;
                    }

                    .settings-save-btn {
                        background: linear-gradient(135deg, var(--primary), var(--secondary));
                        color: white;
                        border: none;
                        padding: 14px;
                        width: 100%;
                        border-radius: 16px;
                        font-size: 1rem;
                        font-weight: 700;
                        cursor: pointer;
                        transition: transform 0.2s;
                        box-shadow: 0 8px 20px rgba(255, 61, 109, 0.25);
                    }

                    .settings-save-btn:hover {
                        transform: translateY(-2px);
                    }

                    @keyframes slideUp {
                        to {
                            transform: translateY(0);
                        }
                    }

                    @media (max-width: 768px) {
                        .container {
                            padding: 15px;
                            padding-bottom: 80px;
                        }

                        .header.glass {
                            padding: 15px;
                        }

                        .logo-text {
                            font-size: 20px !important;
                        }

                        .discover-grid {
                            grid-template-columns: 1fr !important;
                            gap: 16px !important;
                        }

                        .discover-card-banner {
                            height: 120px !important;
                        }

                        .discover-card-content {
                            padding: 20px !important;
                        }

                        .discover-card-name {
                            font-size: 1.2rem !important;
                        }

                        .premium-tabs {
                            overflow-x: auto;
                            display: flex;
                            padding-bottom: 10px;
                            gap: 10px;
                            scrollbar-width: none;
                        }

                        .premium-tabs::-webkit-scrollbar {
                            display: none;
                        }

                        .premium-tab-btn {
                            white-space: nowrap;
                            padding: 8px 16px !important;
                            font-size: 13px !important;
                        }
                    }
                </style>
    </body>

    </html>