<!DOCTYPE html>
<html lang="en">

<head>
    <%- include('partials/head', { title: 'Settings | Sparkle' }) %>
        <style>
            :root {
                --pink-light: #fff0f5;
                --pink-primary: #ff6b8b;
                --pink-dark: #ff3d6d;
            }

            .settings-container {
                max-width: 1000px;
                margin: 0 auto;
                padding: 20px;
            }

            .settings-layout {
                display: grid;
                grid-template-columns: 250px 1fr;
                gap: 20px;
            }

            /* Sidebar Styles */
            .settings-sidebar {
                background: rgba(255, 255, 255, 0.9);
                border-radius: 20px;
                padding: 20px;
                height: fit-content;
                border: 1px solid var(--border);
            }

            .settings-nav-item {
                display: flex;
                align-items: center;
                gap: 12px;
                padding: 12px 15px;
                border-radius: 12px;
                margin-bottom: 5px;
                cursor: pointer;
                transition: all 0.2s;
                color: #64748b;
                border: none;
                background: none;
                width: 100%;
                text-align: left;
                font-size: 15px;
                font-weight: 500;
            }

            .settings-nav-item:hover {
                background: #f8fafc;
                color: var(--pink-dark);
            }

            .settings-nav-item.active {
                background: var(--pink-light);
                color: var(--pink-dark);
                font-weight: 600;
            }

            .settings-nav-item.logout {
                color: #ef4444;
                margin-top: 20px;
                border-top: 1px solid var(--border);
                padding-top: 20px;
                border-radius: 0;
            }

            .settings-nav-item.logout:hover {
                background: #fef2f2;
            }

            /* Content Area */
            .settings-content {
                background: rgba(255, 255, 255, 0.9);
                border-radius: 20px;
                padding: 30px;
                border: 1px solid var(--border);
                min-height: 500px;
            }

            .settings-section {
                display: none;
                animation: fadeIn 0.3s ease;
            }

            .settings-section.active {
                display: block;
            }

            .settings-header {
                margin-bottom: 30px;
                border-bottom: 1px solid #f1f5f9;
                padding-bottom: 20px;
            }

            .settings-header h2 {
                font-size: 24px;
                color: #1e293b;
                margin-bottom: 5px;
            }

            .settings-header p {
                color: #64748b;
            }

            /* Form Styles */
            .form-group {
                margin-bottom: 20px;
            }

            .form-label {
                display: block;
                margin-bottom: 8px;
                font-weight: 600;
                color: #334155;
                font-size: 14px;
            }

            .form-input {
                width: 100%;
                padding: 12px;
                border: 1px solid #e2e8f0;
                border-radius: 10px;
                font-size: 14px;
                transition: border-color 0.2s;
            }

            .form-input:focus {
                outline: none;
                border-color: var(--pink-primary);
            }

            .btn-save {
                background: var(--pink-primary);
                color: white;
                padding: 12px 24px;
                border: none;
                border-radius: 12px;
                font-weight: 600;
                cursor: pointer;
                transition: background 0.2s;
            }

            .btn-save:hover {
                background: var(--pink-dark);
            }

            /* Avatar Upload */
            .profile-upload {
                display: flex;
                align-items: center;
                gap: 20px;
                margin-bottom: 30px;
            }

            .current-avatar {
                width: 80px;
                height: 80px;
                border-radius: 50%;
                object-fit: cover;
                border: 3px solid white;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            }

            .upload-btn {
                background: white;
                border: 1px solid #e2e8f0;
                padding: 8px 16px;
                border-radius: 8px;
                cursor: pointer;
                font-size: 13px;
                font-weight: 500;
            }

            /* Toggles */
            .settings-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 20px 0;
                border-bottom: 1px solid #f1f5f9;
            }

            .settings-item:last-child {
                border-bottom: none;
            }

            .item-info h4 {
                margin: 0 0 4px 0;
                font-size: 15px;
            }

            .item-info p {
                margin: 0;
                font-size: 13px;
                color: #64748b;
            }

            .switch {
                position: relative;
                display: inline-block;
                width: 50px;
                height: 26px;
            }

            .switch input {
                opacity: 0;
                width: 0;
                height: 0;
            }

            .slider {
                position: absolute;
                cursor: pointer;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: #cbd5e1;
                transition: .4s;
                border-radius: 34px;
            }

            .slider:before {
                position: absolute;
                content: "";
                height: 18px;
                width: 18px;
                left: 4px;
                bottom: 4px;
                background-color: white;
                transition: .4s;
                border-radius: 50%;
            }

            input:checked+.slider {
                background-color: var(--pink-primary);
            }

            input:checked+.slider:before {
                transform: translateX(24px);
            }

            @media (max-width: 768px) {
                .settings-container {
                    padding: 15px;
                    padding-bottom: 80px;
                    padding-top: 70px;
                }

                .settings-layout {
                    grid-template-columns: 1fr;
                    gap: 15px;
                }

                .settings-sidebar {
                    display: flex;
                    overflow-x: auto;
                    gap: 10px;
                    padding: 10px;
                    scrollbar-width: none;
                    -ms-overflow-style: none;
                }

                .settings-sidebar::-webkit-scrollbar {
                    display: none;
                }

                .settings-nav-item {
                    white-space: nowrap;
                    width: auto;
                    padding: 8px 16px;
                    margin-bottom: 0;
                    flex-shrink: 0;
                }

                .settings-nav-item.logout {
                    margin-top: 0;
                    border-top: none;
                    padding-top: 8px;
                }

                .settings-content {
                    padding: 20px;
                }

                .settings-header h2 {
                    font-size: 20px;
                }

                .profile-upload {
                    flex-direction: column;
                    align-items: center;
                    text-align: center;
                }
            }
        </style>
</head>

<body>
    <%- include('partials/sidebar') %>
        <%- include('partials/bottom-nav') %>

            <div class="header glass">
                <div class="logo">Settings</div>
            </div>

            <div class="container settings-container">
                <div class="settings-layout">
                    <!-- Navigation -->
                    <div class="settings-sidebar glass">
                        <button class="settings-nav-item active" onclick="showSection('profile', this)">
                            <i class="fas fa-user-circle"></i> Edit Profile
                        </button>
                        <button class="settings-nav-item" onclick="showSection('account', this)">
                            <i class="fas fa-lock"></i> Account & Security
                        </button>
                        <button class="settings-nav-item" onclick="showSection('privacy', this)">
                            <i class="fas fa-shield-alt"></i> Privacy
                        </button>
                        <button class="settings-nav-item" onclick="showSection('notifications', this)">
                            <i class="fas fa-bell"></i> Notifications
                        </button>
                        <button class="settings-nav-item logout" onclick="handleLogout()">
                            <i class="fas fa-sign-out-alt"></i> Log Out
                        </button>
                    </div>

                    <!-- Content -->
                    <div class="settings-content glass">

                        <!-- Profile Section -->
                        <div id="profile" class="settings-section active">
                            <div class="settings-header">
                                <h2>Edit Profile</h2>
                                <p>Customize how you appear to others on Sparkle.</p>
                            </div>

                            <div class="profile-upload">
                                <img src="<%= user.avatar_url || '/uploads/avatars/default.png' %>"
                                    class="current-avatar" id="avatarPreview">
                                <div>
                                    <button class="upload-btn"
                                        onclick="document.getElementById('avatarInput').click()">Change Photo</button>
                                    <input type="file" id="avatarInput" hidden accept="image/*"
                                        onchange="handleAvatarUpload(event)">
                                    <p style="font-size: 12px; color: #94a3b8; margin-top: 5px;">Recommended: Square
                                        JPG, PNG</p>
                                </div>
                            </div>

                            <form id="profileForm">
                                <div class="form-group">
                                    <label class="form-label">Full Name</label>
                                    <input type="text" class="form-input" id="name" value="<%= user.name %>" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Bio</label>
                                    <textarea class="form-input" id="bio" rows="3"><%= user.bio || '' %></textarea>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                    <div class="form-group">
                                        <label class="form-label">Campus</label>
                                        <input type="text" class="form-input" id="campus"
                                            value="<%= user.campus || '' %>">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Major</label>
                                        <input type="text" class="form-input" id="major"
                                            value="<%= user.major || '' %>">
                                    </div>
                                </div>
                                <button type="submit" class="btn-save">Save Changes</button>
                            </form>
                        </div>

                        <!-- Account Section -->
                        <div id="account" class="settings-section">
                            <div class="settings-header">
                                <h2>Account & Security</h2>
                                <p>Manage your login details and account security.</p>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Email Address</label>
                                <input type="email" class="form-input" value="<%= user.email %>" disabled
                                    style="background: #f1f5f9;">
                            </div>

                            <h3 style="margin: 30px 0 20px; font-size: 18px;">Change Password</h3>
                            <form id="passwordForm">
                                <div class="form-group">
                                    <label class="form-label">Current Password</label>
                                    <input type="password" class="form-input" id="currentPass" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">New Password</label>
                                    <input type="password" class="form-input" id="newPass" required>
                                </div>
                                <button type="submit" class="btn-save">Update Password</button>
                            </form>

                            <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #f1f5f9;">
                                <h3 style="color: #ef4444; font-size: 16px; margin-bottom: 10px;">Danger Zone</h3>
                                <button class="settings-nav-item logout" onclick="handleDeleteAccount()"
                                    style="margin-top: 0; width: auto; color: #ef4444;">
                                    <i class="fas fa-trash"></i> Delete Account
                                </button>
                            </div>
                        </div>

                        <!-- Privacy Section -->
                        <div id="privacy" class="settings-section">
                            <div class="settings-header">
                                <h2>Privacy Settings</h2>
                                <p>Control who can see your profile and activity.</p>
                            </div>

                            <div class="settings-item">
                                <div class="item-info">
                                    <h4>Anonymous Mode</h4>
                                    <p>Hide your identity when posting by default.</p>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" onchange="saveSetting('anonymous_enabled', this.checked)"
                                        <%=user.anonymous_enabled ? 'checked' : '' %>>
                                    <span class="slider"></span>
                                </label>
                            </div>

                            <div class="settings-item">
                                <div class="item-info">
                                    <h4>Profile Visibility</h4>
                                    <p>Make your profile visible only to campus members.</p>
                                </div>
                                <label class="switch">
                                    <input type="checkbox"
                                        onchange="saveSetting('profile_visibility', this.checked ? 'campus' : 'public')"
                                        <%=user.profile_visibility==='campus' ? 'checked' : '' %>>
                                    <span class="slider"></span>
                                </label>
                            </div>

                            <div class="settings-item">
                                <div class="item-info">
                                    <h4>Activity Status</h4>
                                    <p>Show when you are active on Sparkle.</p>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" onchange="saveSetting('is_online', this.checked)"
                                        <%=user.is_online !==false ? 'checked' : '' %>>
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>

                        <!-- Notifications Section -->
                        <div id="notifications" class="settings-section">
                            <div class="settings-header">
                                <h2>Notifications</h2>
                                <p>Manage how you want to be notified.</p>
                            </div>

                            <div class="settings-item">
                                <div class="item-info">
                                    <h4>Push Notifications</h4>
                                    <p>Receive notifications on your device.</p>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" onchange="saveSetting('push_notifications', this.checked)"
                                        <%=user.push_notifications ? 'checked' : '' %>>
                                    <span class="slider"></span>
                                </label>
                            </div>

                            <div class="settings-item">
                                <div class="item-info">
                                    <h4>Email Notifications</h4>
                                    <p>Receive updates and digests via email.</p>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" onchange="saveSetting('email_notifications', this.checked)"
                                        <%=user.email_notifications ? 'checked' : '' %>>
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <script src="/js/apiClient.js"></script>
            <script>
                // Navigation
                function showSection(sectionId, btn) {
                    document.querySelectorAll('.settings-nav-item').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    document.querySelectorAll('.settings-section').forEach(s => s.classList.remove('active'));
                    document.getElementById(sectionId).classList.add('active');
                }

                // Avatar Upload
                async function handleAvatarUpload(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    // Preview
                    const reader = new FileReader();
                    reader.onload = e => document.getElementById('avatarPreview').src = e.target.result;
                    reader.readAsDataURL(file);

                    // Upload
                    const formData = new FormData();
                    formData.append('avatar', file);

                    try {
                        const res = await fetch('/api/users/avatar', {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${getCookie('sparkleToken')}` },
                            body: formData
                        });

                        if (res.ok) {
                            // Success
                        } else {
                            alert('Failed to upload avatar');
                        }
                    } catch (err) {
                        console.error(err);
                        alert('Error uploading avatar');
                    }
                }

                // Profile Update
                document.getElementById('profileForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const btn = e.target.querySelector('button');
                    const originalText = btn.innerText;
                    btn.innerText = 'Saving...';
                    btn.disabled = true;

                    const data = {
                        name: document.getElementById('name').value,
                        bio: document.getElementById('bio').value,
                        campus: document.getElementById('campus').value,
                        major: document.getElementById('major').value
                    };

                    try {
                        const res = await fetch('/api/users/profile', {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${getCookie('sparkleToken')}`
                            },
                            body: JSON.stringify(data)
                        });

                        if (res.ok) {
                            alert('Profile updated!');
                        } else {
                            alert('Failed to update profile');
                        }
                    } catch (err) {
                        console.error(err);
                        alert('Error updating profile');
                    } finally {
                        btn.innerText = originalText;
                        btn.disabled = false;
                    }
                });

                // Password Update
                document.getElementById('passwordForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const currentPassword = document.getElementById('currentPass').value;
                    const newPassword = document.getElementById('newPass').value;

                    try {
                        const res = await fetch('/api/users/password', {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${getCookie('sparkleToken')}`
                            },
                            body: JSON.stringify({ currentPassword, newPassword })
                        });

                        if (res.ok) {
                            alert('Password updated successfully');
                            e.target.reset();
                        } else {
                            const data = await res.json();
                            alert(data.error || 'Failed to update password');
                        }
                    } catch (err) {
                        console.error(err);
                        alert('Error updating password');
                    }
                });

                // Settings Update (Privacy/Notifications)
                async function saveSetting(key, value) {
                    try {
                        const res = await fetch('/api/users/settings', {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${getCookie('sparkleToken')}`
                            },
                            body: JSON.stringify({ [key]: value })
                        });

                        if (!res.ok) {
                            const data = await res.json();
                            throw new Error(data.error);
                        }
                        console.log('Setting saved:', key, value);
                    } catch (err) {
                        console.error(err);
                        alert('Failed to save setting');
                        // Revert toggle if needed (complex without state management)
                    }
                }

                // Logout
                function handleLogout() {
                    if (confirm('Are you sure you want to log out?')) {
                        document.cookie = "sparkleToken=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
                        localStorage.removeItem('sparkleToken');
                        localStorage.removeItem('currentUser');
                        localStorage.removeItem('sparkleUser');
                        window.location.href = '/login';
                    }
                }

                // Delete Account
                async function handleDeleteAccount() {
                    const confirmed = prompt('Type "DELETE" to confirm account deletion. This cannot be undone.');
                    if (confirmed === 'DELETE') {
                        try {
                            const res = await fetch('/api/users/me', {
                                method: 'DELETE',
                                headers: { 'Authorization': `Bearer ${getCookie('sparkleToken')}` }
                            });

                            if (res.ok) {
                                alert('Account deleted.');
                                window.location.href = '/login';
                            } else {
                                alert('Failed to delete account');
                            }
                        } catch (err) {
                            console.error(err);
                            alert('Error deleting account');
                        }
                    }
                }

                function getCookie(name) {
                    const value = `; ${document.cookie}`;
                    const parts = value.split(`; ${name}=`);
                    let token = null;
                    if (parts.length === 2) token = parts.pop().split(';').shift();

                    // Fallback to localStorage if cookie is missing
                    if (!token && name === 'sparkleToken') {
                        token = localStorage.getItem('sparkleToken');
                    }
                    return token;
                }
            </script>
</body>

</html>